{% extends "base.html" %}

{% block title %}Logic-Guard - History Log{% endblock %}

{% block content %}
<div class="terminal-container">
    <div class="terminal-header">
        <span class="prompt">&gt;</span> HISTORY LOG
    </div>

    <div class="terminal-content">
        <div class="history-controls">
            <button class="terminal-button" id="refresh-btn">
                <span class="button-icon">&gt;</span> REFRESH
            </button>
            <span class="history-count">Entries: <span id="count">0</span></span>
        </div>

        <div class="terminal-divider"></div>

        <div id="history-list" class="history-list">
            <!-- History entries will be loaded here -->
            <div class="loading-placeholder">
                <p>Loading history... <span class="blink">_</span></p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const historyList = document.getElementById('history-list');
    const countEl = document.getElementById('count');
    const refreshBtn = document.getElementById('refresh-btn');

    async function loadHistory() {
        historyList.innerHTML = '<div class="loading-placeholder"><p>Loading... <span class="blink">_</span></p></div>';

        try {
            const response = await fetch('/api/history?limit=50');
            const data = await response.json();

            countEl.textContent = data.history.length;

            if (data.history.length === 0) {
                historyList.innerHTML = '<div class="empty-state"><p><span class="prompt">&gt;</span> No validation history yet. Start by validating some text.</p></div>';
                return;
            }

            historyList.innerHTML = data.history.reverse().map((entry, index) => `
                <div class="history-entry">
                    <div class="entry-header">
                        <span class="entry-time">${formatTimestamp(entry.timestamp)}</span>
                        <span class="entry-status ${entry.is_valid ? 'success' : 'error'}">
                            ${entry.is_valid ? '[VALID]' : '[INVALID]'}
                        </span>
                    </div>
                    <div class="entry-text">${escapeHtml(entry.input_text)}</div>
                    <div class="entry-meta">
                        <span>Violations: ${entry.violations_count}</span>
                        <span>Corrected: ${entry.was_corrected ? 'Yes' : 'No'}</span>
                        <span>Time: ${entry.processing_time_ms.toFixed(0)}ms</span>
                    </div>
                </div>
            `).join('');

        } catch (error) {
            historyList.innerHTML = `<div class="error-state"><p>[ERROR] Failed to load history: ${error.message}</p></div>`;
        }
    }

    refreshBtn.addEventListener('click', loadHistory);

    function formatTimestamp(isoString) {
        const date = new Date(isoString);
        return date.toLocaleString('en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Initial load
    loadHistory();
});
</script>
{% endblock %}
